name: Update Cargo Hash

on:
  push:
    branches: [master]
    paths:
      - 'Cargo.lock'
      - 'Cargo.toml'
      - 'crates/**/Cargo.toml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cargo-hash:
    name: Update cargoHash
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if cargoHash is up to date
        id: check
        run: |
          set +e
          BUILD_OUTPUT=$(nix build .#claude-chill 2>&1)
          BUILD_EXIT=$?
          set -e

          if [ $BUILD_EXIT -eq 0 ]; then
            echo "cargoHash is up to date"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Build failed output:"
          echo "$BUILD_OUTPUT"

          NEW_HASH=$(echo "$BUILD_OUTPUT" | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+')

          if [ -z "$NEW_HASH" ]; then
            echo "::error::Nix build failed for a reason other than hash mismatch"
            exit 1
          fi

          echo "New cargoHash: $NEW_HASH"
          echo "needs_update=true" >> "$GITHUB_OUTPUT"
          echo "new_hash=$NEW_HASH" >> "$GITHUB_OUTPUT"

      - name: Update flake.nix
        if: steps.check.outputs.needs_update == 'true'
        run: |
          sed -i 's|cargoHash = "sha256-[A-Za-z0-9+/=]*";|cargoHash = "${{ steps.check.outputs.new_hash }}";|' flake.nix
          echo "Updated cargoHash in flake.nix:"
          grep cargoHash flake.nix

      - name: Verify build with new hash
        if: steps.check.outputs.needs_update == 'true'
        run: nix build .#claude-chill

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          BRANCH="chore/update-cargo-hash"
          git checkout -b "$BRANCH"
          git add flake.nix
          git commit -m "chore: update Nix cargoHash"
          git push -u origin "$BRANCH" --force

          # Create PR if one doesn't already exist for this branch
          EXISTING=$(gh pr list --head "$BRANCH" --json number --jq 'length')
          if [ "$EXISTING" = "0" ]; then
            gh pr create \
              --title "chore: update Nix cargoHash" \
              --body "$(cat <<'EOF'
          ## Summary
          - Auto-generated PR to update the `cargoHash` in `flake.nix`
          - Cargo dependencies changed, requiring a new hash for the Nix build

          New hash: `${{ steps.check.outputs.new_hash }}`
          EOF
          )"
          else
            echo "PR already exists, force-pushed updated hash"
          fi
