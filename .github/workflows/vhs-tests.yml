name: VHS Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always
  VHS_VERSION: "0.10.0"

jobs:
  vhs-tests:
    name: VHS Terminal Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install VHS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd

      - name: Install VHS
        run: |
          curl -fsSL -o /tmp/vhs.deb \
            "https://github.com/charmbracelet/vhs/releases/download/v${VHS_VERSION}/vhs_${VHS_VERSION}_amd64.deb"
          sudo dpkg -i /tmp/vhs.deb || sudo apt-get install -f -y
          rm -f /tmp/vhs.deb
          vhs --version

      - name: Build claude-chill
        run: cargo build

      - name: Create output directory
        run: mkdir -p tests/vhs/output

      - name: Run VHS tests
        run: |
          cd ${{ github.workspace }}
          for tape in tests/vhs/*.tape; do
            echo "Running $(basename $tape)..."
            vhs "$tape" || true
          done

      - name: Upload VHS artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vhs-output
          path: tests/vhs/output/*.ascii
          retention-days: 7

      - name: Check for Ctrl-B test (Issue #27)
        id: ctrl-b-check
        run: |
          # This step documents that the Ctrl-B test exists
          # It's expected to show specific behavior that needs verification
          if [ -f tests/vhs/output/ctrl-b.ascii ]; then
            echo "Ctrl-B test output:"
            cat tests/vhs/output/ctrl-b.ascii
            echo ""
            echo "Note: Check the output to verify Ctrl-B cursor movement"
            echo "Expected: ABCDXEF (X inserted before EF)"
            echo "If shows: ABCDEFX (X appended), then Ctrl-B is not working"
          fi
